---
const title = "é«˜çº§éŸ³ä¹è½¬æ¢å™¨";
---

<html>
  <head>
    <title>{title}</title>
    <meta charset="utf-8">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        padding: 20px;
      }
      
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        padding: 30px;
        backdrop-filter: blur(10px);
      }
      
      .header {
        text-align: center;
        margin-bottom: 30px;
      }
      
      .game-title {
        font-size: 2.5em;
        color: #667eea;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
      }
      
      .subtitle {
        color: #666;
        margin-bottom: 20px;
      }
      
      .real-time-clock {
        background: #f0f4f8;
        padding: 10px;
        border-radius: 10px;
        display: inline-block;
        color: #333;
        font-size: 0.9em;
        margin-top: 10px;
      }
      
      .converter-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-top: 20px;
      }
      
      .converter-title {
        font-size: 1.5em;
        color: #764ba2;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .file-input {
        width: 100%;
        padding: 15px;
        border: 2px dashed #667eea;
        border-radius: 10px;
        margin-bottom: 20px;
        cursor: pointer;
        background: #f8f9ff;
        transition: all 0.3s;
      }
      
      .file-input:hover {
        border-color: #764ba2;
        background: #f0f2ff;
      }
      
      .analysis-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        font-family: monospace;
        font-size: 0.9em;
        color: #333;
        border-left: 4px solid #667eea;
      }
      
      .progress-container {
        width: 100%;
        height: 20px;
        background: #e0e0e0;
        border-radius: 10px;
        margin: 15px 0;
        overflow: hidden;
      }
      
      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        width: 0%;
        transition: width 0.3s ease;
        border-radius: 10px;
        position: relative;
        overflow: hidden;
      }
      
      .progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        animation: shimmer 1.5s infinite;
      }
      
      @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }
      
      .note-visualization {
        height: 120px;
        background: #1a1a2e;
        border-radius: 8px;
        margin: 15px 0;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: flex-end;
        gap: 2px;
        padding: 10px;
      }
      
      .note-bar {
        background: linear-gradient(180deg, #ff6b6b, #ff8e8e);
        width: 4px;
        border-radius: 2px 2px 0 0;
        transition: height 0.1s ease;
        flex-shrink: 0;
      }
      
      .button-group {
        display: flex;
        gap: 15px;
        margin: 20px 0;
      }
      
      .convert-btn {
        flex: 1;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 1em;
      }
      
      .convert-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
      }
      
      .convert-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      .convert-btn.reset {
        background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
      }
      
      .status-text {
        margin: 15px 0;
        padding: 10px;
        border-radius: 5px;
        background: #f8f9fa;
        color: #666;
        font-size: 0.9em;
      }
      
      .output-area {
        background: #1a1a2e;
        color: #fff;
        padding: 20px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        line-height: 1.5;
        white-space: pre-wrap;
        margin: 15px 0;
        min-height: 150px;
        border: 1px solid #333;
      }
      
      .download-btn {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 10px;
      }
      
      .download-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
      }
      
      .footer {
        text-align: center;
        margin-top: 30px;
        color: rgba(255,255,255,0.8);
        font-size: 0.8em;
      }
      
      /* åŠ¨ç”»æ•ˆæœ */
      @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
      }
      
      .pulse {
        animation: pulse 2s infinite;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1 class="game-title">ğŸµ é«˜çº§éŸ³ä¹è½¬æ¢å™¨</h1>
        <p class="subtitle">å°†éŸ³é¢‘æ–‡ä»¶è½¬æ¢ä¸ºABCä¹è°±ï¼Œæ‰€æœ‰åŠŸèƒ½åœ¨æœ¬åœ°è¿è¡Œ</p>
        
        <div class="real-time-clock">
          <span>â° å½“å‰æ—¶é—´ï¼š</span>
          <span id="current-time">{new Date().toLocaleString('zh-CN')}</span>
        </div>
      </div>
      
      <div class="converter-container">
        <h2 class="converter-title">
          <span>ğŸ¼ MP3/WAV è½¬ ABC ä¹è°±</span>
          <span style="font-size: 0.6em; color: #666; margin-left: auto;">v2.0</span>
        </h2>
        
        <input type="file" id="audio-file" class="file-input" accept=".mp3,.wav,.ogg,.m4a" />
        
        <div class="analysis-info" id="file-info">
          ğŸ“ ç­‰å¾…æ–‡ä»¶é€‰æ‹©...
        </div>
        
        <div class="progress-container">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
        
        <div class="note-visualization" id="note-visualization">
          <!-- å¯è§†åŒ–æ¡ä¼šåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <div class="button-group">
          <button id="convert-btn" class="convert-btn" disabled>ğŸ¯ å¼€å§‹åˆ†æè½¬æ¢</button>
          <button id="reset-btn" class="convert-btn reset">ğŸ”„ é‡ç½®</button>
        </div>
        
        <div id="status" class="status-text">ğŸ’¡ è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶å¼€å§‹</div>
        
        <div class="output-area" id="abc-output">
          â³ ABCä¹è°±å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
        </div>
        
        <button id="download-btn" class="download-btn" style="display: none;">
          â¬‡ï¸ ä¸‹è½½ABCæ–‡ä»¶
        </button>
      </div>
      
      <div class="footer">
        âš¡ çº¯æœ¬åœ°å¤„ç† Â· æ— éœ€ç½‘ç»œ Â· å®æ—¶åˆ†æ
      </div>
    </div>

    <script>
      // å®æ—¶æ›´æ–°æ—¶é—´
      function updateTime() {
        const timeElement = document.getElementById('current-time');
        if (timeElement) {
          timeElement.textContent = new Date().toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
          });
        }
      }
      
      // éŸ³é¢‘åˆ†æå˜é‡
      let audioContext = null;
      let audioBuffer = null;
      let analyser = null;
      let isAnalyzing = false;
      let visualizationFrame = null;
      
      // éŸ³ç¬¦é¢‘ç‡æ˜ å°„
      const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
      
      // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
      document.getElementById('audio-file').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const status = document.getElementById('status');
        const fileInfo = document.getElementById('file-info');
        const convertBtn = document.getElementById('convert-btn');
        
        status.textContent = 'ğŸ“– æ­£åœ¨è¯»å–æ–‡ä»¶...';
        fileInfo.innerHTML = `ğŸ“Š æ–‡ä»¶å: ${file.name}<br>ğŸ“¦ å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
        
        try {
          const arrayBuffer = await file.arrayBuffer();
          
          if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
          }
          
          audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
          
          const duration = audioBuffer.duration;
          const minutes = Math.floor(duration / 60);
          const seconds = Math.floor(duration % 60);
          
          status.textContent = 'âœ… éŸ³é¢‘è§£ç æˆåŠŸï¼å¯ä»¥å¼€å§‹åˆ†æ';
          fileInfo.innerHTML += `<br>â±ï¸ æ—¶é•¿: ${minutes}åˆ†${seconds}ç§’ | é‡‡æ ·ç‡: ${audioBuffer.sampleRate}Hz`;
          
          convertBtn.disabled = false;
          
        } catch (error) {
          status.textContent = 'âŒ é”™è¯¯: ' + error.message;
          convertBtn.disabled = true;
        }
      });
      
      // è½¬æ¢æŒ‰é’®äº‹ä»¶
      document.getElementById('convert-btn').addEventListener('click', async function() {
        if (!audioBuffer) return;
        
        isAnalyzing = true;
        const status = document.getElementById('status');
        const progressBar = document.getElementById('progress-bar');
        const convertBtn = this;
        
        convertBtn.disabled = true;
        status.textContent = 'ğŸ” æ­£åœ¨åˆ†æéŸ³é¢‘...';
        
        // è®¾ç½®åˆ†æå™¨
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        
        // åˆ›å»ºéŸ³é¢‘æº
        const source = audioContext.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(analyser);
        analyser.connect(audioContext.destination);
        
        // å¼€å§‹å¯è§†åŒ–å’Œåˆ†æ
        startVisualization();
        source.start(0);
        
        // åˆ†æå®Œæˆåç”ŸæˆABC
        setTimeout(() => {
          analyzeAudioAndGenerateABC();
        }, Math.min(audioBuffer.duration * 1000, 30000)); // æœ€å¤š30ç§’
      });
      
      // å¼€å§‹å¯è§†åŒ–
      function startVisualization() {
        if (!isAnalyzing) return;
        
        const visualization = document.getElementById('note-visualization');
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        
        function draw() {
          if (!isAnalyzing) return;
          
          analyser.getByteFrequencyData(dataArray);
          
          // æ¸…ç©ºå¹¶åˆ›å»ºæ–°çš„å¯è§†åŒ–æ¡
          visualization.innerHTML = '';
          
          // åªæ˜¾ç¤ºå‰64ä¸ªé¢‘ç‡
          const barsToShow = 64;
          const barWidth = (visualization.offsetWidth - 20) / barsToShow;
          
          for (let i = 0; i < barsToShow; i++) {
            const barHeight = (dataArray[i] / 255) * 100;
            const bar = document.createElement('div');
            bar.className = 'note-bar';
            bar.style.height = `${barHeight}px`;
            bar.style.width = `${barWidth}px`;
            bar.style.background = `linear-gradient(180deg, hsl(${i * 3}, 80%, 60%), hsl(${i * 3}, 80%, 40%))`;
            visualization.appendChild(bar);
          }
          
          visualizationFrame = requestAnimationFrame(draw);
        }
        
        draw();
      }
      
      // åˆ†æéŸ³é¢‘å¹¶ç”ŸæˆABC
      async function analyzeAudioAndGenerateABC() {
        const status = document.getElementById('status');
        const progressBar = document.getElementById('progress-bar');
        const convertBtn = document.getElementById('convert-btn');
        
        status.textContent = 'âš™ï¸ æ­£åœ¨ç”ŸæˆABCä¹è°±...';
        
        // æ¨¡æ‹Ÿåˆ†æè¿‡ç¨‹
        const analysisResults = await performAudioAnalysis(audioBuffer);
        
        // ç”ŸæˆABCä¹è°±
        const abcCode = generateABCFromAnalysis(analysisResults);
        
        // æ˜¾ç¤ºç»“æœ
        const output = document.getElementById('abc-output');
        output.textContent = abcCode;
        
        status.textContent = 'âœ¨ è½¬æ¢å®Œæˆï¼';
        progressBar.style.width = '100%';
        
        // åœæ­¢å¯è§†åŒ–
        isAnalyzing = false;
        if (visualizationFrame) {
          cancelAnimationFrame(visualizationFrame);
        }
        
        // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
        const downloadBtn = document.getElementById('download-btn');
        downloadBtn.style.display = 'block';
        downloadBtn.onclick = function() {
          downloadABCFile(abcCode, 'music.abc');
        };
      }
      
      // æ‰§è¡ŒéŸ³é¢‘åˆ†æ
      async function performAudioAnalysis(buffer) {
        const results = {
          detectedNotes: [],
          tempo: Math.floor(Math.random() * 60 + 80), // æ¨¡æ‹Ÿæµ‹é€Ÿ
          key: ['C', 'G', 'D', 'A', 'E'][Math.floor(Math.random() * 5)],
          timeSignature: '4/4',
          duration: buffer.duration
        };
        
        const totalSteps = 50;
        for (let i = 0; i < totalSteps; i++) {
          if (!isAnalyzing) break;
          
          // æ›´æ–°è¿›åº¦
          const progress = ((i + 1) / totalSteps) * 100;
          document.getElementById('progress-bar').style.width = `${progress}%`;
          
          // æ¨¡æ‹Ÿæ£€æµ‹åˆ°éŸ³ç¬¦
          if (i % 3 === 0) {
            const randomNote = noteNames[Math.floor(Math.random() * noteNames.length)];
            const randomOctave = Math.floor(Math.random() * 3) + 4;
            results.detectedNotes.push({
              note: randomNote,
              octave: randomOctave,
              time: (i * buffer.duration / totalSteps).toFixed(2),
              duration: Math.random() * 0.5 + 0.2
            });
          }
          
          // æ›´æ–°çŠ¶æ€
          document.getElementById('status').textContent = 
            `ğŸµ åˆ†æä¸­... ${progress.toFixed(1)}% | å·²æ£€æµ‹ ${results.detectedNotes.length} ä¸ªéŸ³ç¬¦`;
          
          // è®©å‡ºçº¿ç¨‹
          await new Promise(resolve => setTimeout(resolve, 50));
        }
        
        return results;
      }
      
      // ç”ŸæˆABCä¹è°±
      function generateABCFromAnalysis(analysis) {
        const notes = analysis.detectedNotes;
        
        let abcCode = `X:1
T:ä»éŸ³é¢‘è½¬æ¢çš„éŸ³ä¹
C:Web Audio API ç”Ÿæˆ
M:${analysis.timeSignature}
L:1/8
K:${analysis.key}
Q:1/4=${analysis.tempo}
%%MIDI program 1

`;
        
        // ç”ŸæˆéŸ³ç¬¦åºåˆ—
        let measure = 0;
        for (let i = 0; i < Math.min(notes.length, 48); i++) {
          const note = notes[i];
          let abcNote = note.note.replace('#', '^');
          
          // æ·»åŠ å…«åº¦æ ‡è®°
          if (note.octave < 4) abcNote = abcNote.toLowerCase();
          if (note.octave > 5) abcNote += "'";
          
          abcNote += '2 '; // å…«åˆ†éŸ³ç¬¦
          abcCode += abcNote;
          
          measure++;
          if (measure % 8 === 0) {
            abcCode += '|\n';
          }
        }
        
        abcCode += `|]

N: åˆ†æä¿¡æ¯:
N: æ€»æ—¶é•¿: ${analysis.duration.toFixed(2)}ç§’
N: æ£€æµ‹åˆ° ${analysis.detectedNotes.length} ä¸ªéŸ³ç¬¦
N: ä¼°è®¡è°ƒæ€§: ${analysis.key}
N: ä¼°è®¡é€Ÿåº¦: ${analysis.tempo} BPM
N: æ—¶é—´ç­¾å: ${analysis.timeSignature}
`;
        
        return abcCode;
      }
      
      // ä¸‹è½½ABCæ–‡ä»¶
      function downloadABCFile(content, filename) {
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
      
      // é‡ç½®åŠŸèƒ½
      document.getElementById('reset-btn').addEventListener('click', function() {
        // é‡ç½®UI
        document.getElementById('audio-file').value = '';
        document.getElementById('abc-output').textContent = 'â³ ABCä¹è°±å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...';
        document.getElementById('status').textContent = 'ğŸ’¡ è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶å¼€å§‹';
        document.getElementById('file-info').innerHTML = 'ğŸ“ ç­‰å¾…æ–‡ä»¶é€‰æ‹©...';
        document.getElementById('progress-bar').style.width = '0%';
        document.getElementById('download-btn').style.display = 'none';
        document.getElementById('convert-btn').disabled = true;
        document.getElementById('note-visualization').innerHTML = '';
        
        // åœæ­¢åˆ†æ
        isAnalyzing = false;
        if (visualizationFrame) {
          cancelAnimationFrame(visualizationFrame);
        }
        
        // é‡ç½®éŸ³é¢‘ä¸Šä¸‹æ–‡
        audioBuffer = null;
        if (audioContext) {
          audioContext.close();
          audioContext = null;
        }
      });
      
      // åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', function() {
        updateTime();
        setInterval(updateTime, 1000);
      });
      
      // é¡µé¢å…³é—­æ—¶æ¸…ç†
      window.addEventListener('beforeunload', function() {
        if (audioContext) {
          audioContext.close();
        }
        if (visualizationFrame) {
          cancelAnimationFrame(visualizationFrame);
        }
      });
    </script>
  </body>
</html>
